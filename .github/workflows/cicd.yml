name: CI

on:
  push:
    branches: [dev] # dev ë¸Œëœì¹˜ì— pushë  ë•Œ ì‹¤í–‰

env:
  SPRING_PROFILES_ACTIVE: test

jobs:
  # âœ… CI ë‹¨ê³„: ì½”ë“œ í…ŒìŠ¤íŠ¸ ë° Docker ì´ë¯¸ì§€ ë¹Œë“œ
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Debug Maven Central Access
        run: curl -I https://repo.maven.apache.org/maven2/
        
      - name: Build & Test Spring Boot Application
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test # í•„ìš” ì‹œ -x test ì œê±°í•˜ì—¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê°€ëŠ¥

      - name: Check if Dockerfile exists
        run: ls -al

      - name: Build Docker Image
        run: |
          docker build -t carebridge-app .

      - name: Save Docker Image
        run: |
          docker save -o carebridge-app.tar carebridge-app

      - name: Upload Docker Image to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: carebridge-app
          path: carebridge-app.tar

  # âœ… CD ë‹¨ê³„: EC2 ë°°í¬ ë° ì»¨í…Œì´ë„ˆ ì‹¤í–‰
  deploy:
    needs: build # CI ì„±ê³µ í›„ ì‹¤í–‰
    runs-on: ubuntu-latest

    steps:
      - name: Download Docker Image Artifact
        uses: actions/download-artifact@v4
        with:
          name: carebridge-app
          path: .

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ls -al ~/.ssh  # SSH í‚¤ê°€ ì •ìƒì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆëŠ”ì§€ í™•ì¸

      - name: Debug SSH Key
        run: echo "${{ secrets.SSH_PRIVATE_KEY }}" | wc -l

      - name: Test SSH Connection
        run: ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSH Connection Success'"

      - name: Upload Docker Image to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "carebridge-app.tar"
          target: "/home/ec2-user/app/"

      - name: Deploy Application on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ

            echo "ğŸ“Œ EC2ì— ì ‘ì†í•˜ì—¬ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."

            cd /home/ec2-user/app/

            echo "ğŸ“Œ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ"
            docker ps -a
            docker stop carebridge-container || true
            docker rm carebridge-container || true

            echo "ğŸ“Œ ê¸°ì¡´ Docker ì´ë¯¸ì§€ ì‚­ì œ"
            docker images
            docker rmi -f carebridge-app || true

            echo "ğŸ“Œ Docker ì´ë¯¸ì§€ ë¡œë“œ ì‹œì‘"
            if [ ! -f "carebridge-app.tar" ]; then
              echo "âŒ Error: Docker image file 'carebridge-app.tar' not found!"
              exit 1
            fi
            docker load -i carebridge-app.tar

            echo "ğŸ“Œ Docker ì´ë¯¸ì§€ ëª©ë¡ í™•ì¸"
            docker images

            echo "ğŸ“Œ ìµœì‹  ë¡œë“œëœ Docker ì´ë¯¸ì§€ ID í™•ì¸"
            IMAGE_ID=$(docker images --format "{{.Repository}} {{.ID}}" | grep "carebridge-app" | awk '{print $2}')

            if [ -z "$IMAGE_ID" ]; then
              echo "âŒ Error: No IMAGE_ID found. Docker image might not have been loaded properly."
              exit 1
            fi

            echo "âœ… Docker ì´ë¯¸ì§€ê°€ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë¨: IMAGE_ID=$IMAGE_ID"
            
            echo "SPRING_PROFILES_ACTIVE=test" > .env
            echo "SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}" >> .env
            echo "SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}" >> .env
            echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}" >> .env
            echo "OPENAI_SECRET_KEY=${{ secrets.OPENAI_SECRET_KEY }}" >> .env
            echo "MESSAGE_API_KEY=${{ secrets.MESSAGE_API_KEY }}" >> .env
            echo "MESSAGE_API_SECRET=${{ secrets.MESSAGE_API_SECRET }}" >> .env
            echo "KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}" >> .env
            echo "KAKAO_REDIRECT_URL=${{ secrets.KAKAO_REDIRECT_URL }}" >> .env
            echo "KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}" >> .env
            cat .env  # ë¡œê·¸ í™•ì¸ìš© (í•„ìš”í•˜ë©´ ì œê±°)
            
            docker run -d -p 8080:8080 --name carebridge-container --restart always --env-file .env carebridge-app
            echo "ğŸ“Œ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸"
            docker ps
            echo "âœ… EC2 ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
